# Pipeline to deploy an Azure DevopsDeployment Agent

parameters:
- name: location
  displayName: Region
  type: string
  default: "eastus2euap"
  values:
  - "West Europe"
  - "North Europe"
  - "Germany West Central"
  - "eastus2euap"

- name: mgmt-rg
  displayName: Resource group prefix for landing zone resources, location will be added (e.g. saponazure-westeurope)
  type: string
  default: "SAPonAzure-"

- name: deployervmname
  displayName: DevOps Deployment Agent VM name prefix, location will be added (e.g. devopsagent-westeurope)
  type: string
  default: "devopsagent-"

- name: deployerhostname
  displayName: DevOps Deployment Agent hostname prefix, location will be added (e.g. devopsagent-westeurope)
  type: string
  default: "devopsagent-"

- name: winvmname
  displayName: Windows Admin VM name prefix
  type: string
  default: "winadmin-"

- name: winhostname
  displayName: Windows Admin hostname prefix
  type: string
  default: "winadmin-"

- name: vnetrange
  displayName: VNET range
  type: string
  default: "10.10.0.0/16"

- name: bastionsubnetrange
  displayName: Bastion subnet range
  type: string
  default: "10.10.2.0/24"

- name: adminsubnetrange
  displayName: Admin subnet range
  type: string
  default: "10.10.3.0/24"

- name: sapsubnetrange
  displayName: SAP subnet range
  type: string
  default: "10.10.10.0/24"

- name: rsvtype
  displayName: Recovery Service Vault Type
  type: string
  default: "LocallyRedundant"
  values:
  - "LocallyRedundant"
  - "ZoneRedundant"
  - "GeoRedundant"

- name: crr
  displayName: Recovery Service Vault Cross Region Restore enabled
  type: boolean
  default: False

trigger:
- none

pool:
  vmImage: ubuntu-latest

variables:
  subnetid: /subscriptions/$(subscription)/resourceGroups/$(VNET_RG)/providers/Microsoft.Network/virtualNetworks/${{ parameters.vnet_subnet }}

steps:
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Pipeline Artifact'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)'
        artifact: agent

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy an Agent'
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(AZURE_CONNECTION_NAME)'
        subscriptionId: '$(ARM_SUBSCRIPTION_ID)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: ${{ parameters.adminrg }}
        location: ${{ parameters.location }}
        templateLocation: 'Linked artifact'
        csmFile: $(System.DefaultWorkingDirectory)/ARM-Template/sap-landing-zone.json
        overrideParameters: '-adminUsername "$(adminuser)" -adminPublicKey "$(sshkey)" -WindowsPassword "$(winpw)" -DevOpsDeployerVMName "${{ parameters.deployervmname }}" -DevOpsDeployerComputerName "${{ parameters.deployerhostname }}" -subnetId "$(subnetid)" -Script_URL "$(url-agent-cfg)" -diagnosticsStorageAccountName "$(diagnosticsStorageAccountName)" '
        deploymentMode: 'Incremental'
        deploymentName: 'sap-landing-zone-$(Build.BuildId)'

